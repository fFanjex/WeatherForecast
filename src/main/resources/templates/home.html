<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WeatherForecast ‚Ä¢ Home</title>

    <link rel="stylesheet" href="/home.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.5.2/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@7.5.2/dist/ol.js"></script>
</head>
<body>
<div class="bg"></div>
<div class="noise"></div>

<header class="header">
    <div class="container header-inner">
        <div class="brand">
            <div class="logo" aria-hidden="true">WF</div>
            <div class="brand-text">
                <div class="brand-title">WeatherForecast</div>
                <div class="brand-subtitle">–ü–æ–≥–æ–¥–∞ ‚Ä¢ –§–∞–∫—Ç—ã ‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div>
            </div>
        </div>

        <form id="logout" action="/logout" method="post">
            <button class="logout-btn" type="submit" aria-label="–í—ã–π—Ç–∏">
                <span class="logout-ico" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none">
                        <path d="M10 7V6a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-6a2 2 0 0 1-2-2v-1"
                              stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M14 12H3m0 0 3-3M3 12l3 3"
                              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </span>
                <span>–í—ã—Ö–æ–¥</span>
            </button>
        </form>
    </div>
</header>

<main class="main-content">
    <div class="container grid">
        <section class="card hero" id="description-card">
            <div class="hero-top">
                <div class="badge">üå§ Live</div>
                <div class="hero-title">
                    <h1 id="welcome-title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>
                    <p class="subtitle">–ì–æ—Ç–æ–≤—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–≥–æ–¥—É –∏ –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã?</p>
                </div>
            </div>

            <div class="user-cards">
                <div class="info-tile">
                    <div class="tile-ico" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none">
                            <path d="M20 21a8 8 0 0 0-16 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <path d="M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <div>
                        <div class="label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                        <div class="value" id="user-id">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
                    </div>
                </div>

                <div class="info-tile">
                    <div class="tile-ico" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none">
                            <path d="M12 22s7-4.5 7-12a7 7 0 1 0-14 0c0 7.5 7 12 7 12Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                            <path d="M12 11a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </div>
                    <div>
                        <div class="label">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –≥–æ—Ä–æ–¥</div>
                        <div class="value skeleton" id="city-name">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
                    </div>
                </div>
            </div>

            <div class="hero-footer">
                <p class="intro">
                    üåç –ü–æ–ª—É—á–∏—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–≥–æ–¥–µ –≤ –ª—é–±–æ–º —É–≥–æ–ª–∫–µ –ø–ª–∞–Ω–µ—Ç—ã ‚Äî –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –∫–∞–∫ –æ–¥–µ—Ç—å—Å—è —Å–µ–≥–æ–¥–Ω—è.
                </p>

                <div class="mini-stats">
                    <div class="stat">
                        <div class="stat-num">3</div>
                        <div class="stat-text">—Ä–∞–∑–¥–µ–ª–∞</div>
                    </div>
                    <div class="stat">
                        <div class="stat-num">‚ö°</div>
                        <div class="stat-text">–±—ã—Å—Ç—Ä–æ</div>
                    </div>
                    <div class="stat">
                        <div class="stat-num">üéØ</div>
                        <div class="stat-text">–ø–æ–ª–µ–∑–Ω–æ</div>
                    </div>
                </div>

                <div class="map-block">
                    <div class="map-head">
                        <div class="map-title">üìç –í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</div>
                        <div class="map-sub" id="map-status">–û–ø—Ä–µ–¥–µ–ª—è–µ–º‚Ä¶</div>
                    </div>
                    <div id="home-map" class="home-map"></div>
                </div>
            </div>
        </section>

        <section class="card actions">
            <h2 class="actions-title">–ß—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?</h2>
            <p class="actions-subtitle">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –Ω–∏–∂–µ.</p>

            <div class="actions-grid">
                <form action="/view-weather" method="get">
                    <button class="action-tile weather" type="submit">
                        <div class="tile-head">
                            <div class="tile-icon">üå§</div>
                            <div class="tile-text">
                                <div class="tile-title">–ü–æ–≥–æ–¥–∞</div>
                                <div class="tile-desc">–ü—Ä–æ–≥–Ω–æ–∑, —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, —É—Å–ª–æ–≤–∏—è</div>
                            </div>
                        </div>
                        <div class="tile-cta">–û—Ç–∫—Ä—ã—Ç—å ‚Üí</div>
                    </button>
                </form>

                <form action="/interesting-fact" method="get">
                    <button class="action-tile fact" type="submit">
                        <div class="tile-head">
                            <div class="tile-icon">üí°</div>
                            <div class="tile-text">
                                <div class="tile-title">–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∞–∫—Ç</div>
                                <div class="tile-desc">–ö–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ–∑–Ω–∞–≤–∞—Ç–µ–ª—å–Ω–æ</div>
                            </div>
                        </div>
                        <div class="tile-cta">–û—Ç–∫—Ä—ã—Ç—å ‚Üí</div>
                    </button>
                </form>

                <form action="/clothing-advice" method="get">
                    <button class="action-tile clothes" type="submit">
                        <div class="tile-head">
                            <div class="tile-icon">üß•</div>
                            <div class="tile-text">
                                <div class="tile-title">–°–æ–≤–µ—Ç—ã –ø–æ –æ–¥–µ–∂–¥–µ</div>
                                <div class="tile-desc">–ö–∞–∫ –æ–¥–µ—Ç—å—Å—è –ø–æ –ø–æ–≥–æ–¥–µ</div>
                            </div>
                        </div>
                        <div class="tile-cta">–û—Ç–∫—Ä—ã—Ç—å ‚Üí</div>
                    </button>
                </form>
            </div>

            <div class="tip">
                <span class="tip-ico">‚ú®</span>
                <span>–°–æ–≤–µ—Ç: —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –≥–æ—Ä–æ–¥ ‚Äî –∏ –ø—Ä–æ–≥–Ω–æ–∑ –±—É–¥–µ—Ç –≤—Å–µ–≥–¥–∞ –ø–æ–¥ —Ä—É–∫–æ–π.</span>
            </div>
        </section>
    </div>
</main>

<footer class="footer">
    <div class="container footer-inner">
        <p>¬© 2025 Weather Forecast ‚Ä¢ –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã</p>
        <p class="footer-muted">Made with ‚òÅÔ∏è &amp; ‚òÄÔ∏è</p>
    </div>
</footer>

<script>
    const mapStatus = document.getElementById('map-status');
    const defaultLon = 37.618423;
    const defaultLat = 55.751244;

    const marker = new ol.Feature({
        geometry: new ol.geom.Point(ol.proj.fromLonLat([defaultLon, defaultLat]))
    });

    marker.setStyle(new ol.style.Style({
        image: new ol.style.Circle({
            radius: 7,
            fill: new ol.style.Fill({ color: '#4F7CFF' }),
            stroke: new ol.style.Stroke({ color: '#ffffff', width: 2 })
        })
    }));

    const vectorLayer = new ol.layer.Vector({
        source: new ol.source.Vector({ features: [marker] })
    });

    const map = new ol.Map({
        target: 'home-map',
        layers: [
            new ol.layer.Tile({ source: new ol.source.OSM() }),
            vectorLayer
        ],
        view: new ol.View({
            center: ol.proj.fromLonLat([defaultLon, defaultLat]),
            zoom: 10
        }),
        controls: []
    });

    const setPoint = (lat, lon, zoom = 11) => {
        const coords = ol.proj.fromLonLat([lon, lat]);
        marker.getGeometry().setCoordinates(coords);
        map.getView().animate({ center: coords, zoom, duration: 600 });
    };

    async function geocodeCity(cityName) {
        const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(cityName)}`;
        const r = await fetch(url, {
            headers: {
                "Accept": "application/json"
            }
        });
        if (!r.ok) throw new Error('Nominatim search error');
        const arr = await r.json();
        if (!Array.isArray(arr) || arr.length === 0) return null;

        return {
            lat: Number(arr[0].lat),
            lon: Number(arr[0].lon),
            displayName: arr[0].display_name
        };
    }
    fetch('/api/home')
        .then(r => {
            if (!r.ok) {
                window.location.href = '/login';
                return;
            }
            return r.json();
        })
        .then(async (data) => {
            document.getElementById('user-id').textContent = data.username || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';

            const cityEl = document.getElementById('city-name');
            cityEl.classList.remove('skeleton');

            const savedCity = (data.savedCity || '').trim();
            cityEl.textContent = savedCity || '–Ω–µ –≤—ã–±—Ä–∞–Ω–æ';
            if (!savedCity) {
                mapStatus.textContent = '–ì–æ—Ä–æ–¥ –Ω–µ –≤—ã–±—Ä–∞–Ω ‚Äî –ø–æ–∫–∞–∑–∞–Ω–∞ –ú–æ—Å–∫–≤–∞';
                setPoint(defaultLat, defaultLon, 10);
                return;
            }

            mapStatus.textContent = '–ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –≥–æ—Ä–æ–¥‚Ä¶';

            try {
                const geo = await geocodeCity(savedCity);
                if (!geo || Number.isNaN(geo.lat) || Number.isNaN(geo.lon)) {
                    mapStatus.textContent = '–ù–µ —Å–º–æ–≥–ª–∏ –Ω–∞–π—Ç–∏ –≥–æ—Ä–æ–¥ ‚Äî –ø–æ–∫–∞–∑–∞–Ω–∞ –ú–æ—Å–∫–≤–∞';
                    setPoint(defaultLat, defaultLon, 10);
                    return;
                }

                setPoint(geo.lat, geo.lon, 11);
                mapStatus.textContent = `–ü–æ–∫–∞–∑–∞–Ω –≥–æ—Ä–æ–¥: ${savedCity}`;
            } catch (e) {
                console.error(e);
                mapStatus.textContent = '–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞ ‚Äî –ø–æ–∫–∞–∑–∞–Ω–∞ –ú–æ—Å–∫–≤–∞';
                setPoint(defaultLat, defaultLon, 10);
            }
        })
        .catch(() => {
            const cityEl = document.getElementById('city-name');
            cityEl.classList.remove('skeleton');
            cityEl.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';

            mapStatus.textContent = '–û—à–∏–±–∫–∞ ‚Äî –ø–æ–∫–∞–∑–∞–Ω–∞ –ú–æ—Å–∫–≤–∞';
            setPoint(defaultLat, defaultLon, 10);
        });
</script>
</body>
</html>